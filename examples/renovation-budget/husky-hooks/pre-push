#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ========================================
# Pre-push Hook
# Private Renovation Budget Manager
# ========================================
#
# Comprehensive Testing Before Push
# Ensures code quality and security before pushing to remote
#
# Checks performed:
# 1. All linting checks
# 2. Full test suite
# 3. Security audit
# 4. Build verification

echo "ğŸš€ Running pre-push checks..."
echo ""

# ========================================
# 1. Quick Linting
# ========================================
echo "ğŸ“ [1/4] Running quick lint check..."
npm run lint
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Linting failed!"
  echo "   Run: npm run lint:fix"
  echo ""
  exit 1
fi
echo "âœ… Linting passed"
echo ""

# ========================================
# 2. Test Suite
# ========================================
echo "ğŸ§ª [2/4] Running test suite..."
npm test
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Tests failed!"
  echo "   Fix failing tests before pushing"
  echo ""
  exit 1
fi
echo "âœ… Tests passed"
echo ""

# ========================================
# 3. Security Audit
# ========================================
echo "ğŸ”’ [3/4] Running security audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo ""
  echo "âš ï¸  Security vulnerabilities detected!"
  echo "   Run: npm audit fix"
  echo ""
  # Non-blocking for now, just warning
fi
echo "âœ… Security audit complete"
echo ""

# ========================================
# 4. Build Verification
# ========================================
echo "ğŸ—ï¸  [4/4] Verifying build..."
npm run compile
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Build failed!"
  echo "   Fix compilation errors before pushing"
  echo ""
  exit 1
fi
echo "âœ… Build verified"
echo ""

# ========================================
# Success Message
# ========================================
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   âœ… All pre-push checks passed! ğŸ‰   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Summary:"
echo "  âœ… Linting"
echo "  âœ… Tests (75+)"
echo "  âœ… Security audit"
echo "  âœ… Build verification"
echo ""
echo "ğŸš€ Ready to push to remote!"
echo ""
