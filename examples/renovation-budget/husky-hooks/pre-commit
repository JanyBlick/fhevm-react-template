#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ========================================
# Pre-commit Hook
# Private Renovation Budget Manager
# ========================================
#
# Security & Quality Checks (Left-Shift Strategy)
# Runs before every commit to catch issues early
#
# Checks performed:
# 1. Solidity linting (Solhint)
# 2. JavaScript/TypeScript linting (ESLint)
# 3. Code formatting (Prettier)
# 4. Secret detection
# 5. Gas usage warnings

echo "ğŸ”’ Running pre-commit security checks..."
echo ""

# ========================================
# 1. Solidity Linting
# ========================================
echo "ğŸ“ [1/5] Checking Solidity code quality (Solhint)..."
npm run lint:sol
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Solidity linting failed!"
  echo "   Fix errors with: npm run lint:fix"
  echo ""
  exit 1
fi
echo "âœ… Solidity linting passed"
echo ""

# ========================================
# 2. JavaScript/TypeScript Linting
# ========================================
echo "ğŸ“ [2/5] Checking JavaScript/TypeScript code quality (ESLint)..."
npm run lint:js
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ JavaScript/TypeScript linting failed!"
  echo "   Fix errors with: npm run lint:js:fix"
  echo ""
  exit 1
fi
echo "âœ… JavaScript/TypeScript linting passed"
echo ""

# ========================================
# 3. Code Formatting
# ========================================
echo "ğŸ¨ [3/5] Checking code formatting (Prettier)..."
npm run format:check
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Code formatting check failed!"
  echo "   Auto-format with: npm run format"
  echo ""
  exit 1
fi
echo "âœ… Code formatting check passed"
echo ""

# ========================================
# 4. Secret Detection
# ========================================
echo "ğŸ” [4/5] Scanning for secrets and sensitive data..."
npm run check:secrets
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Potential secrets detected!"
  echo "   Review and remove sensitive data before committing"
  echo ""
  exit 1
fi
echo "âœ… No secrets detected"
echo ""

# ========================================
# 5. Contract Size Check
# ========================================
echo "ğŸ“ [5/5] Checking contract sizes..."
npm run check:size
if [ $? -ne 0 ]; then
  echo ""
  echo "âš ï¸  Contract size warning (non-blocking)"
  echo ""
fi
echo "âœ… Contract size check complete"
echo ""

# ========================================
# Success Message
# ========================================
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… All pre-commit checks passed! ğŸ‰  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Summary:"
echo "  âœ… Solidity linting"
echo "  âœ… JavaScript/TypeScript linting"
echo "  âœ… Code formatting"
echo "  âœ… Secret detection"
echo "  âœ… Contract size check"
echo ""
echo "ğŸš€ Ready to commit!"
echo ""
